# PHASE 2 Implementation Plan: JSON Output Parsing & Production Rollback Automation

**Status**: Planning
**Estimated Duration**: 5-6 hours
**Priority**: High (enables reliable migration handling)

## Overview

This phase implements two critical improvements to PrintOptim's Confiture integration:
1. **JSON Output Parsing** (1-2 hours) - Replace fragile regex with stable structured output
2. **Production Rollback Automation** (3-4 hours) - Enable automated recovery from failed migrations

Both improvements directly leverage Confiture v0.3.7+ (Trinity pattern compatible) and are foundational for PrintOptim's deployment safety.

---

## Part 1: JSON Output Parsing (1-2 hours)

### Current Architecture

PrintOptim has a migration runner in `src/printoptim_backend/entrypoints/api/` that currently:
- Uses CLI subprocess calls to confiture
- Parses text output with fragile regex patterns
- Lacks structured error handling

Key files:
- `scripts/deployment/core/deployment-runner.py` - Main deployment orchestrator
- Database reset utilities in `src/printoptim_backend/entrypoints/api/utilities/reseed_data.py`

### What Needs to Change

1. **Create MigrationRunner class** - Encapsulate confiture interaction
   - Wrap confiture subprocess calls
   - Always use `--json` flag for structured output
   - Parse JSON responses with proper error handling
   - Provide clean Python API (`.status()`, `.up()`, `.down()`)

2. **File location**: Create new file
   - `src/printoptim_backend/core/migration_runner.py`

3. **MigrationRunner interface**:
   ```python
   class MigrationResult(TypedDict):
       success: bool
       applied_migrations: list[str]
       error: str | None
       stderr: str | None

   class MigrationStatus(TypedDict):
       has_pending: bool
       pending_migrations: list[str]
       applied_migrations: list[str]

   class MigrationRunner:
       def __init__(self, config_path: str, app_path: str)
       def status() -> MigrationStatus
       def up(dry_run: bool = False) -> MigrationResult
       def down() -> MigrationResult
       def baseline(through: str) -> MigrationResult
   ```

4. **Update deployment-runner.py**:
   - Replace subprocess calls with MigrationRunner
   - Replace text parsing with JSON handling
   - Improve error reporting with structured data
   - Keep all existing logic and safety mechanisms

### Implementation Strategy

**Step 1: Create MigrationRunner class**
- Handle confiture process execution
- Add `--json` flag to all confiture calls
- Parse JSON responses with error handling
- Provide type-safe Python API

**Step 2: Update deployment-runner.py**
- Replace confiture subprocess calls with MigrationRunner
- Update migration status checks
- Update migration up/down calls
- Replace regex parsing with JSON parsing

**Step 3: Test**
- Verify JSON parsing works with Confiture v0.3.7+
- Test error cases (connection failures, invalid JSON)
- Test dry-run flag
- Test with real migration scenarios

---

## Part 2: Production Rollback Automation (3-4 hours)

### Current Architecture

Production migration handling in deployment-runner.py currently:
- Checks migration status
- Applies migrations with validation
- **MISSING**: Automatic rollback on failure

### What Needs to Change

1. **Add rollback detection** in deployment-runner.py:
   - Check for `.rollback_pending` marker file at start
   - Execute rollback if marker exists
   - Clean up marker on success

2. **Add rollback marker creation** on migration failure:
   - When migration fails, write `.rollback_pending` file
   - Include migration details (name, timestamp, error)
   - Mark deployment as pending rollback

3. **Lazy rollback strategy** (recommended):
   - Migration fails → write marker → return failure
   - Next systemd timer cycle detects marker
   - Automatically rolls back within same systemd service
   - Cleans up marker on success

### Implementation Strategy

**Step 1: Update MigrationRunner**
- Add `.down()` method for rollback
- Ensure it works with `--json` flag
- Return structured rollback results

**Step 2: Add rollback marker management**
- Create helper functions to read/write `.rollback_pending` file
- Marker format: JSON with migration name, timestamp, error
- Location: `{APP_PATH}/.rollback_pending`

**Step 3: Update deployment workflow**
- On migration failure: create marker, log critical alert
- On systemd timer cycle: check marker at startup
- If marker exists: execute rollback, clean up marker
- If rollback succeeds: log success
- If rollback fails: log critical, keep marker for manual intervention

**Step 4: Enhance logging and alerting**
- Log all rollback attempts with timestamps
- Include migration names and errors
- Add markers to help ops team debug issues

### Safety Features

- **Staged rollback**: Two cycles allow operators to observe failures
- **Marker-based**: Safe to check without side effects
- **Logged**: All rollback attempts logged for audit trail
- **Manual fallback**: If automatic rollback fails, marker remains for manual intervention
- **Idempotent**: Running rollback multiple times is safe

---

## Implementation Order

1. **Create MigrationRunner** - Foundation for both improvements
   - File: `src/printoptim_backend/core/migration_runner.py`
   - Wraps confiture CLI with JSON parsing
   - ~150-200 lines of code

2. **Update deployment-runner.py** - Use MigrationRunner
   - Replace subprocess calls with MigrationRunner methods
   - Remove regex parsing
   - ~50-100 lines of changes

3. **Add rollback marker system** - Enable rollback automation
   - Helper functions for marker management
   - Add marker checks at deployment start
   - Add marker creation on migration failure
   - ~100-150 lines of code

4. **Test both improvements** - Verify functionality
   - Unit tests for MigrationRunner
   - Integration tests for deployment workflow
   - Manual testing with staging/production databases

---

## Files to Modify/Create

### New Files
- `src/printoptim_backend/core/migration_runner.py` - MigrationRunner class

### Files to Modify
- `scripts/deployment/core/deployment-runner.py` - Use MigrationRunner, add rollback logic
- `pyproject.toml` - Add types/typing if needed (psutil? pydantic models?)

### Optional Enhancements
- Add pydantic models for type-safe responses
- Add logging configuration for rollback events
- Add monitoring hooks for alerting ops

---

## Risk Assessment

**Low Risk**: JSON parsing only uses confiture's documented `--json` flag
**Low Risk**: Rollback uses existing confiture CLI that's already in use
**Medium Risk**: Marker file approach requires careful file handling (use pathlib)
**Medium Risk**: Timing of rollback detection needs to be right (not too aggressive)

---

## Success Criteria

✅ All migration status checks use `--json` flag
✅ Regex parsing completely removed
✅ MigrationRunner handles all confiture operations
✅ Rollback marker created on migration failure
✅ Automatic rollback works on next timer cycle
✅ Rollback marker cleaned up on success
✅ All existing safety features preserved
✅ Logging tracks all rollback events
✅ No production impact during staging tests

---

## Testing Plan

1. **Unit tests** (30 min):
   - MigrationRunner JSON parsing
   - Marker file creation/cleanup
   - Error handling for invalid JSON

2. **Integration tests** (60 min):
   - Full deployment flow with migrations
   - Rollback marker detection
   - Rollback execution

3. **Staging tests** (60 min):
   - Test actual migration on staging database
   - Trigger failure and verify rollback
   - Test timing with systemd timer

4. **Verification** (30 min):
   - Confirm no regex parsing remains
   - Verify JSON error messages
   - Check all safety mechanisms still work

---

## Deliverables

1. **MigrationRunner class** - Encapsulates confiture CLI interaction
2. **Updated deployment-runner.py** - Uses MigrationRunner, handles rollback
3. **Tests** - Unit and integration tests for both improvements
4. **Documentation** - How rollback automation works
5. **Git commits** - Two atomic commits (one per improvement)

